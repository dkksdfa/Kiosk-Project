<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>204호 디지털 방명록</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <!-- 폰트 변경: Nanum Pen Script -> Dongle -->
    <link href="https://fonts.googleapis.com/css2?family=Dongle:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            overflow: hidden;
            touch-action: none; /* 터치 드래그 시 화면 밀림 방지 */
            user-select: none;
        }
        .font-hand {
            /* 폰트 스타일 변경 */
            font-family: 'Dongle', sans-serif;
            font-weight: 400;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* 메모지 그림자 효과 */
        .note-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div id="root" class="h-screen w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 아이콘 (SVG) ---
        const EditIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>;
        const TrashIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;
        const XIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const PlusIcon = () => <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const CheckIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;

        // --- 색상 팔레트 ---
        const COLORS = [
            { bg: 'bg-yellow-200', text: 'text-yellow-900', label: '노랑' },
            { bg: 'bg-rose-200', text: 'text-rose-900', label: '분홍' },
            { bg: 'bg-blue-200', text: 'text-blue-900', label: '파랑' },
            { bg: 'bg-emerald-200', text: 'text-emerald-900', label: '초록' },
            { bg: 'bg-purple-200', text: 'text-purple-900', label: '보라' },
        ];

        // --- 메인 앱 ---
        const App = () => {
            const [notes, setNotes] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [inputText, setInputText] = useState("");
            const [selectedColor, setSelectedColor] = useState(0);
            
            // 드래그 상태 관리
            const [draggingId, setDraggingId] = useState(null);
            const dragOffset = useRef({ x: 0, y: 0 });

            // 1. 초기 로드: 로컬 스토리지에서 데이터 불러오기
            useEffect(() => {
                const savedNotes = localStorage.getItem('seminar-guestbook');
                if (savedNotes) {
                    try {
                        setNotes(JSON.parse(savedNotes));
                    } catch (e) {
                        console.error("데이터 로드 실패", e);
                    }
                } else {
                    // 초기 데이터 (예시)
                    setNotes([
                        { id: 1, text: "204호 세미나실 화이팅!", x: 100, y: 150, colorIdx: 0, rotation: -2 },
                        { id: 2, text: "과제 마감 D-1... 살려줘", x: 300, y: 300, colorIdx: 1, rotation: 3 },
                    ]);
                }
            }, []);

            // 2. 변경 시 저장: notes가 바뀔 때마다 로컬 스토리지 업데이트
            useEffect(() => {
                if (notes.length > 0) { // 빈 배열일 때 저장을 막으려면 조건 추가 가능
                     localStorage.setItem('seminar-guestbook', JSON.stringify(notes));
                }
            }, [notes]);

            // 메모 추가 핸들러
            const addNote = () => {
                if (!inputText.trim()) return;

                // 랜덤 위치 (화면 중앙 근처)
                const startX = window.innerWidth / 2 - 100 + (Math.random() * 100 - 50);
                const startY = window.innerHeight / 2 - 100 + (Math.random() * 100 - 50);
                const rotation = Math.random() * 10 - 5; // -5도 ~ +5도 회전

                const newNote = {
                    id: Date.now(),
                    text: inputText,
                    x: startX,
                    y: startY,
                    colorIdx: selectedColor,
                    rotation: rotation
                };

                setNotes([...notes, newNote]);
                setInputText("");
                setIsModalOpen(false);
            };

            // 전체 삭제 핸들러
            const clearNotes = () => {
                if(confirm("모든 방명록을 지우시겠습니까?")) {
                    setNotes([]);
                    localStorage.removeItem('seminar-guestbook');
                }
            };

            // 메모 삭제 핸들러 (더블 클릭 또는 X버튼)
            const deleteNote = (id, e) => {
                e.stopPropagation(); // 드래그 이벤트 전파 방지
                if(confirm("이 메모를 떼어내시겠습니까?")) {
                    setNotes(notes.filter(n => n.id !== id));
                }
            };

            // --- 드래그 앤 드롭 로직 ---
            const handlePointerDown = (e, id) => {
                const note = notes.find(n => n.id === id);
                if (!note) return;

                setDraggingId(id);
                // 터치/마우스 좌표와 메모의 현재 위치 차이 계산
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                dragOffset.current = {
                    x: clientX - note.x,
                    y: clientY - note.y
                };
            };

            const handlePointerMove = (e) => {
                if (!draggingId) return;

                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                
                if (!clientX || !clientY) return;

                setNotes(notes.map(note => {
                    if (note.id === draggingId) {
                        return {
                            ...note,
                            x: clientX - dragOffset.current.x,
                            y: clientY - dragOffset.current.y
                        };
                    }
                    return note;
                }));
            };

            const handlePointerUp = () => {
                setDraggingId(null);
            };

            return (
                <div 
                    className="h-full w-full relative bg-slate-900 overflow-hidden"
                    onMouseMove={handlePointerMove}
                    onMouseUp={handlePointerUp}
                    onTouchMove={handlePointerMove}
                    onTouchEnd={handlePointerUp}
                >
                    {/* 배경 그리드 패턴 */}
                    <div className="absolute inset-0 opacity-20 pointer-events-none" 
                         style={{backgroundImage: 'radial-gradient(#94a3b8 1px, transparent 1px)', backgroundSize: '40px 40px'}}>
                    </div>

                    {/* 상단 헤더 */}
                    <header className="absolute top-0 left-0 right-0 p-6 flex justify-between items-start z-10 pointer-events-none">
                        <div>
                            <h1 className="text-4xl font-black text-white tracking-tighter drop-shadow-lg">
                                <span className="text-blue-500">204호</span> 방명록
                            </h1>
                            <p className="text-slate-400 mt-2 text-lg">자유롭게 터치하여 흔적을 남겨주세요.</p>
                        </div>
                        <div className="pointer-events-auto">
                            <button 
                                onClick={clearNotes}
                                // 휴지통 버튼에 pointer-events-auto 추가
                                className="bg-slate-800/80 hover:bg-rose-900/80 text-white p-3 rounded-xl backdrop-blur transition-colors border border-slate-700 pointer-events-auto"
                            >
                                <TrashIcon />
                            </button>
                        </div>
                    </header>

                    {/* 메모 표시 영역 */}
                    {notes.map(note => {
                        const style = COLORS[note.colorIdx];
                        const isDragging = draggingId === note.id;

                        return (
                            <div
                                key={note.id}
                                onMouseDown={(e) => handlePointerDown(e, note.id)}
                                onTouchStart={(e) => handlePointerDown(e, note.id)}
                                className={`absolute p-6 w-64 min-h-[160px] flex flex-col justify-between ${style.bg} ${style.text} shadow-xl cursor-move select-none transition-shadow note-shadow`}
                                style={{
                                    left: note.x, 
                                    top: note.y, 
                                    transform: `rotate(${note.rotation}deg) scale(${isDragging ? 1.05 : 1})`,
                                    zIndex: isDragging ? 50 : 10,
                                    // 폰트 스타일 적용 변경
                                    fontFamily: '"Dongle", sans-serif',
                                    fontSize: '1.5rem', // 폰트 크기 조정
                                    lineHeight: '1.2'
                                }}
                            >
                                {/* 핀 (장식) */}
                                <div className="absolute -top-3 left-1/2 transform -translate-x-1/2 w-4 h-4 rounded-full bg-red-500 shadow-md border border-red-700"></div>

                                <p className="leading-snug break-words whitespace-pre-wrap font-hand">{note.text}</p>
                                
                                <div className="flex justify-end mt-4">
                                    <button 
                                        onClick={(e) => deleteNote(note.id, e)}
                                        // X 버튼 드래그 이벤트 전파 방지 추가
                                        onMouseDown={(e) => e.stopPropagation()}
                                        onTouchStart={(e) => e.stopPropagation()}
                                        className="opacity-50 hover:opacity-100 p-2 hover:bg-black/10 rounded-full transition-all"
                                    >
                                        <XIcon />
                                    </button>
                                </div>
                            </div>
                        );
                    })}

                    {/* 하단 글쓰기 버튼 (플로팅) */}
                    <div className="absolute bottom-8 right-8 z-20">
                        <button 
                            onClick={() => setIsModalOpen(true)}
                            className="w-20 h-20 bg-blue-600 hover:bg-blue-500 text-white rounded-full shadow-2xl flex items-center justify-center transition-transform hover:scale-110 active:scale-95 animate-bounce"
                        >
                            <PlusIcon />
                        </button>
                    </div>

                    {/* 글쓰기 모달 */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white rounded-3xl w-full max-w-lg p-6 shadow-2xl transform transition-all scale-100">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold text-slate-800">새 메모 작성</h2>
                                    <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-600">
                                        <XIcon />
                                    </button>
                                </div>

                                <textarea
                                    value={inputText}
                                    onChange={(e) => setInputText(e.target.value)}
                                    placeholder="여기에 내용을 입력하세요..."
                                    className={`w-full h-40 p-6 text-2xl font-hand border-none rounded-xl mb-6 resize-none focus:ring-2 focus:ring-blue-500 outline-none ${COLORS[selectedColor].bg} ${COLORS[selectedColor].text} placeholder-opacity-50`}
                                    autoFocus
                                    // 모달 내 textarea 폰트 크기 조정
                                    style={{ fontSize: '1.8rem' }}
                                />

                                {/* 색상 선택기 */}
                                <div className="flex gap-3 mb-8 justify-center">
                                    {COLORS.map((color, idx) => (
                                        <button
                                            key={idx}
                                            onClick={() => setSelectedColor(idx)}
                                            className={`w-10 h-10 rounded-full border-2 transition-transform ${color.bg} ${selectedColor === idx ? 'border-blue-500 scale-125' : 'border-transparent'}`}
                                            aria-label={color.label}
                                        />
                                    ))}
                                </div>

                                <button 
                                    onClick={addNote}
                                    disabled={!inputText.trim()}
                                    className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-lg hover:bg-slate-800 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                >
                                    <CheckIcon />
                                    게시하기
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const rootElement = document.getElementById('root');
        if (rootElement) {
            const root = ReactDOM.createRoot(rootElement);
            root.render(<App />);
        } else {
            console.error("Root element not found");
        }
    </script>
</body>
</html>
